generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// =========================================================
// 1. THE USER (Client / Customer)
// =========================================================

model User {
  id           String  @id @default(uuid())
  email        String  @unique
  username     String  @unique
  passwordHash String?
  googleId     String? @unique // Unique ONLY within Users

  name      String
  avatarUrl String?

  // Preferences
  promotionalEmailsEnabled Boolean         @default(false)
  themePreference          ThemePreference @default(SYSTEM)

  // Security
  emailVerificationToken     String?   @unique
  emailVerificationExpiresAt DateTime?
  emailVerifiedAt            DateTime?
  passwordResetToken         String?   @unique
  passwordResetExpiresAt     DateTime?

  isBlocked Boolean   @default(false)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lastLogin                 DateTime?
  emailNotificationsEnabled Boolean   @default(true)

  // Relations
  refreshSessions RefreshSession[]
  bookings        Booking[]        @relation("UserBookings") // Appointments they made
  reviews         Review[]         @relation("UserReviews") // Reviews they wrote
}

// =========================================================
// 2. THE EXPERT (Service Provider)
// =========================================================

model Expert {
  id           String  @id @default(uuid())
  email        String  @unique
  passwordHash String?
  googleId     String? @unique // Unique ONLY within Experts

  name      String
  username  String  @unique // Public handle (e.g. @dr_smith)
  avatarUrl String?

  lastLogin                 DateTime?
  emailNotificationsEnabled Boolean         @default(true)
  promotionalEmailsEnabled  Boolean         @default(false)
  themePreference           ThemePreference @default(SYSTEM)

  // Professional Profile
  headline    String?
  bio         String?
  hourlyRate  Decimal? @db.Decimal(10, 2)
  specialties String[]

  // Geo-Location (PostGIS Ready)
  latitude  Float?
  longitude Float?

  isVerified Boolean @default(false)

  // Security
  emailVerificationToken     String?   @unique
  emailVerificationExpiresAt DateTime?
  emailVerifiedAt            DateTime?
  passwordResetToken         String?   @unique
  passwordResetExpiresAt     DateTime?

  isBlocked Boolean   @default(false)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  refreshSessions RefreshSession[]
  services        Service[]
  bookings        Booking[]        @relation("ExpertBookings")
  reviews         Review[]         @relation("ExpertReviews")
  availability    Availability[]

  // Organization Relation (Optional: Expert works for Org)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  // PostGIS Index for "Find near me"
  // @@index([latitude, longitude], name: "expert_geo_index", type: Gist)
}

// =========================================================
// 3. THE ORGANIZATION (Business Entity)
// =========================================================

model Organization {
  id           String  @id @default(uuid())
  email        String  @unique
  username     String  @unique
  passwordHash String?
  googleId     String? @unique

  lastLogin                 DateTime?
  emailNotificationsEnabled Boolean   @default(true)

  companyName      String
  logoUrl          String?
  websiteUrl       String?
  companyRegNumber String?
  address          String?

  // Security
  emailVerificationToken     String?   @unique
  emailVerificationExpiresAt DateTime?
  emailVerifiedAt            DateTime?
  passwordResetToken         String?   @unique
  passwordResetExpiresAt     DateTime?

  isBlocked Boolean   @default(false)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  refreshSessions RefreshSession[]
  experts         Expert[] // Experts that belong to this org
}

// =========================================================
// 4. THE ADMIN (Platform Manager)
// =========================================================

model Admin {
  id           String  @id @default(uuid())
  email        String  @unique
  username     String  @unique
  passwordHash String?

  lastLogin                 DateTime?
  emailNotificationsEnabled Boolean   @default(true)

  name      String
  avatarUrl String?
  role      AdminRole @default(MODERATOR)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  refreshSessions RefreshSession[]
}

// =========================================================
// 5. SHARED SYSTEMS
// =========================================================

model RefreshSession {
  id        String @id @default(uuid())
  tokenHash String @unique

  expiresAt DateTime
  createdAt DateTime @default(now())

  ipAddress String?
  userAgent String?

  // Polymorphic Relation: Session belongs to EXACTLY ONE of these
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  expertId String?
  expert   Expert? @relation(fields: [expertId], references: [id], onDelete: Cascade)

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  adminId String?
  admin   Admin?  @relation(fields: [adminId], references: [id], onDelete: Cascade)
}

// Marketplace Models

model Service {
  id          String  @id @default(uuid())
  title       String
  description String?
  price       Decimal @db.Decimal(10, 2)
  durationMin Int
  bufferMin   Int     @default(0)
  isActive    Boolean @default(true)

  expertId String
  expert   Expert    @relation(fields: [expertId], references: [id], onDelete: Cascade)
  bookings Booking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Booking {
  id String @id @default(uuid())

  // The Customer
  userId String
  user   User   @relation("UserBookings", fields: [userId], references: [id])

  // The Provider
  expertId String
  expert   Expert @relation("ExpertBookings", fields: [expertId], references: [id])

  // The Service
  serviceId String
  service   Service @relation(fields: [serviceId], references: [id])

  startTime DateTime
  endTime   DateTime
  status    BookingStatus @default(PENDING)

  priceSnapshot Decimal @db.Decimal(10, 2)
  meetingLink   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  review Review?
}

model Review {
  id      String  @id @default(uuid())
  rating  Int // 1-5
  comment String?

  bookingId String  @unique
  booking   Booking @relation(fields: [bookingId], references: [id])

  authorId String
  author   User   @relation("UserReviews", fields: [authorId], references: [id])

  expertId String
  expert   Expert @relation("ExpertReviews", fields: [expertId], references: [id])

  createdAt DateTime @default(now())
}

model Availability {
  id       String @id @default(uuid())
  expertId String
  expert   Expert @relation(fields: [expertId], references: [id], onDelete: Cascade)

  dayOfWeek Int // 0=Sun, 1=Mon...
  startTime String // "09:00"
  endTime   String // "17:00"
  isActive  Boolean @default(true)
}

// Enums

enum AdminRole {
  SUPER_ADMIN
  MODERATOR
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum ThemePreference {
  LIGHT
  DARK
  SYSTEM
}
